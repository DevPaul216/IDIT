// IDIT - Intex Digital Inventory Tool
// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")  // For migrations (bypasses connection pooler)
}

// ==========================================
// User Management (Simple PIN-based)
// ==========================================

model User {
  id        String   @id @default(cuid())
  name      String
  pin       String   // 4-digit PIN for quick login
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  inventoryChecks CurrentInventory[]
  inventoryLogs   InventoryLog[]
}

// ==========================================
// Inventory Management Tables
// ==========================================

// Storage locations on the floor (e.g., "UG", "UG > Wachsraum")
// Supports hierarchical structure with parent-child relationships
model StorageLocation {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  // Parent location for hierarchical structure
  parentId    String?
  parent      StorageLocation?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children    StorageLocation[] @relation("LocationHierarchy")
  // Position for visual floor layout (grid coordinates)
  x           Int      @default(0)
  y           Int      @default(0)
  width       Int      @default(1)
  height      Int      @default(1)
  // Visual customization
  color       String?
  // Capacity for leaf storage areas (null means unlimited/not set)
  capacity    Int?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  currentInventory CurrentInventory[]
  inventoryLogs    InventoryLog[]
}

// Types of products/goods stored on pallets
// Categories: "raw" (Rohmaterial), "finished" (Fertigprodukte), "packaging" (Verpackung)
model ProductVariant {
  id             String   @id @default(cuid())
  name           String
  code           String?  @unique  // Short code for quick entry
  articleNumber  String?  @unique  // Official article/SKU number
  category       String   @default("finished")  // raw, finished, packaging
  color          String?  // Color for visual distinction
  resourceWeight Float?   // Weight in kg (e.g., a bale might have 350 kg)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  currentInventory CurrentInventory[]
  inventoryLogs    InventoryLog[]
}

// Current live inventory state - always reflects the real warehouse
// Each location+product combo has exactly one entry (or none if never checked)
model CurrentInventory {
  id              String   @id @default(cuid())
  locationId      String
  productId       String
  quantity        Int      // Number of pallets (0 = explicitly empty)
  lastCheckedAt   DateTime @default(now())
  lastCheckedById String

  location        StorageLocation @relation(fields: [locationId], references: [id])
  product         ProductVariant  @relation(fields: [productId], references: [id])
  lastCheckedBy   User            @relation(fields: [lastCheckedById], references: [id])

  @@unique([locationId, productId])
}

// Audit log for all inventory changes - used for analytics and history
model InventoryLog {
  id              String   @id @default(cuid())
  locationId      String
  productId       String
  previousQty     Int?     // null if first entry for this location+product
  newQty          Int
  changedById     String
  changedAt       DateTime @default(now())

  location        StorageLocation @relation(fields: [locationId], references: [id])
  product         ProductVariant  @relation(fields: [productId], references: [id])
  changedBy       User            @relation(fields: [changedById], references: [id])
}
